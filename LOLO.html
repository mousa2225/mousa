<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>حاسبة الاسترداد اليومي</title>
<style>
  body {
    font-family: 'Cairo', sans-serif;
    background-color: #f0f6fa;
    color: #333;
    padding: 25px;
  }
  h2 {
    text-align: center;
    color: #1565c0;
    margin-bottom: 20px;
  }
  .calculator {
    background: #fff;
    padding: 25px;
    border-radius: 14px;
    max-width: 950px;
    margin: auto;
    box-shadow: 0 6px 18px rgba(0,0,0,0.1);
  }
  .client-section {
    background: #e3f2fd;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 15px;
    position: relative;
  }
  .client-section h3 {
    color: #0d47a1;
    margin-bottom: 10px;
  }
  label {
    display: block;
    margin-top: 8px;
    font-weight: bold;
    color: #0d47a1;
  }
  input {
    width: 100%;
    padding: 8px;
    margin-top: 4px;
    border: 1px solid #bbdefb;
    border-radius: 8px;
    font-size: 15px;
    text-align: center;
  }
  .remove-btn {
    position: absolute;
    top: 10px;
    left: 10px;
    background: #e53935;
    color: white;
    border: none;
    border-radius: 50%;
    width: 26px;
    height: 26px;
    font-weight: bold;
    cursor: pointer;
  }
  button {
    background: #1e88e5;
    border: none;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    margin: 10px 5px;
  }
  button:hover { background: #1565c0; }
  .add-btn { background: #43a047; }
  .add-btn:hover { background: #2e7d32; }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    text-align: center;
    table-layout: fixed;
  }
  th, td {
    border: 2px solid #333;
    padding: 10px;
    font-family: Arial, sans-serif;
    font-weight: bold;
    font-size: 15px;
  }
  th { background-color: #1e88e5; color: white; }
  td { background: #ffffff; } /* خلية فارغة بدون لون */
  .result-section { margin-top: 25px; }
</style>
</head>
<body>

<div class="calculator">
  <h2>📊 حاسبة الاسترداد المالي لعدة عملاء</h2>

  <div id="clientsContainer"></div>

  <button class="add-btn" onclick="addClient()">➕ إضافة عميل</button>
  <button onclick="calculateAll()">💰 احسب لجميع العملاء</button>
  <button onclick="exportToExcel()">📁 تصدير إلى Excel</button>

  <div class="result-section" id="results"></div>
</div>

<script>
let clientCount = 0;
let clientsData = [];

function addClient() {
  clientCount++;
  clientsData.push(clientCount);
  const clientHTML = `
  <div class="client-section" id="client-${clientCount}">
    <button class="remove-btn" onclick="removeClient(${clientCount})">×</button>
    <h3>👤 بيانات العميل ${clientCount}</h3>

    <label>اسم العميل:</label>
    <input type="text" id="name-${clientCount}">

    <label>رقم العميل:</label>
    <input type="text" id="id-${clientCount}">

    <label>قيمة الباقة:</label>
    <input type="number" id="price-${clientCount}">

    <label>عدد أيام الباقة:</label>
    <input type="number" id="days-${clientCount}">

    <label>عدد الأيام المستفاد بها:</label>
    <input type="number" id="used-${clientCount}">

    <label>اسم البنك:</label>
    <input type="text" id="bank-${clientCount}">

    <label>رقم الحساب البنكي:</label>
    <input type="text" id="account-${clientCount}">

    <label>نوع الاشتراك:</label>
    <input type="text" id="subscription-${clientCount}">

    <label>الملاحظات:</label>
    <input type="text" id="notes-${clientCount}">
  </div>`;
  document.getElementById("clientsContainer").insertAdjacentHTML("beforeend", clientHTML);
}

function removeClient(id) {
  const el = document.getElementById(`client-${id}`);
  if (el) el.remove();
  clientsData = clientsData.filter(c => c !== id);
}

function calculateAll() {
  if (clientsData.length === 0) { document.getElementById("results").innerHTML = ""; return; }

  let tableHTML = `
  <table>
    <tr>
      <th>رقم العميل</th>
      <th>قيمة الباقة المشترك عليها</th>
      <th>عدد الأيام المستفاد بها</th>
      <th>المبلغ المسترد</th>
    </tr>`;

  clientsData.forEach(id => {
    const price = parseFloat(document.getElementById(`price-${id}`)?.value) || 0;
    const totalDays = parseFloat(document.getElementById(`days-${id}`)?.value) || 1;
    const used = parseFloat(document.getElementById(`used-${id}`)?.value) || 0;
    const remaining = Math.max(totalDays - used, 0);
    const refund = (price / totalDays) * remaining;
    tableHTML += `
    <tr>
      <td>${document.getElementById(`id-${id}`)?.value || ""}</td>
      <td>${price.toFixed(2)} (${totalDays})</td>
      <td>${used}</td>
      <td style="color:#2e7d32; font-weight:bold;">${refund.toFixed(2)}</td>
    </tr>`;
  });

  tableHTML += "</table>";
  document.getElementById("results").innerHTML = tableHTML;
}

function exportToExcel() {
  if (clientsData.length === 0) return alert("الرجاء إدخال بيانات العملاء أولاً.");

  let today = new Date();
  today.setDate(today.getDate() - 1);
  const day = today.getDate();
  const month = today.toLocaleString('ar-SA', { month: 'long' });
  const fileName = `ملف الاسترداد اليومي ${day} ${month}.xls`;

  let excelHtml = `<table border="1" style="border-collapse:collapse; font-family:Arial; font-weight:bold; font-size:14px; width:100%;">`;
  excelHtml += `<tr style="background-color:#1e88e5; color:white;">
    <th>اسم العميل</th>
    <th>رقم العميل</th>
    <th>قيمة الباقة المشترك عليها</th>
    <th>عدد الأيام المستفاد بها</th>
    <th>اسم البنك</th>
    <th>رقم الحساب البنكي</th>
    <th>نوع الاشتراك</th>
    <th>المبلغ المسترد</th>
    <th>الملاحظات</th>
  </tr>`;

  clientsData.forEach(id => {
    const name = document.getElementById(`name-${id}`)?.value || "";
    const cid = document.getElementById(`id-${id}`)?.value || "";
    const price = parseFloat(document.getElementById(`price-${id}`)?.value) || 0;
    const days = parseFloat(document.getElementById(`days-${id}`)?.value) || 1;
    const used = parseFloat(document.getElementById(`used-${id}`)?.value) || 0;
    const refund = (price / days) * Math.max(days - used, 0);
    const bank = document.getElementById(`bank-${id}`)?.value || "";
    const account = document.getElementById(`account-${id}`)?.value || "";
    const subscription = document.getElementById(`subscription-${id}`)?.value || "";
    const notes = document.getElementById(`notes-${id}`)?.value || "";
    const priceWithDays = `${price.toFixed(2)} (${days})`;

    excelHtml += `<tr>
      <td>${name}</td>
      <td>${cid}</td>
      <td>${priceWithDays}</td>
      <td>${used}</td>
      <td>${bank}</td>
      <td>${account}</td>
      <td>${subscription}</td>
      <td>${refund.toFixed(2)}</td>
      <td>${notes}</td>
    </tr>`;
  });

  // توقيع
  excelHtml += `<tr>
    <td colspan="9" style="text-align:right; font-weight:bold; color:#FF5722; font-size:16px;">
      ✒️ Accountant Mousa
    </td>
  </tr>`;
  excelHtml += `</table>`;

  const blob = new Blob([excelHtml], { type: "application/vnd.ms-excel" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = fileName;
  a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
