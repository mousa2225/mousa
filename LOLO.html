<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>حاسبة الاسترداد اليومي</title>
<style>
/* ======================== إعدادات عامة ======================== */
body {
  font-family: "Tahoma", Arial, sans-serif;
  background: linear-gradient(180deg, #e0f7fa 0%, #ffffff 100%);
  margin: 0;
  padding: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
  box-sizing: border-box;
}

h1 { 
  color: #0288d1; 
  text-align: center; 
  margin-bottom: 25px; 
  font-size: 24px; 
}

/* ======================== حاوية الادخالات ======================== */
.container {
  width: 100%;
  max-width: 480px;
  background: #fff;
  border-radius: 14px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  padding: 20px;
  box-sizing: border-box;
  margin-bottom: 20px;
}

label { 
  font-weight: bold; 
  color: #00796b; 
  font-size: 14px; 
  margin-top: 10px; 
}

input, select {
  width: 100%; 
  padding: 10px; 
  margin-top: 5px; 
  border: 2px solid #03a9f4;
  border-radius: 6px; 
  font-size: 14px; 
  text-align: center; 
  transition: 0.3s;
  box-sizing: border-box;
}

input:focus, select:focus { 
  border-color: #0288d1; 
  background-color: #e1f5fe; 
  outline: none; 
}

button {
  width: 100%; 
  background-color: #03a9f4; 
  color: white; 
  border: none;
  padding: 10px; 
  border-radius: 6px; 
  cursor: pointer; 
  font-size: 15px; 
  font-weight: bold;
  margin-top: 10px; 
  transition: 0.3s;
}
button:hover { background-color: #0288d1; }
button.delete { background-color: #f44336; font-size: 13px; padding: 6px 8px; }
button.edit { background-color: #ffa726; font-size: 13px; padding: 6px 8px; margin-left:5px; }

/* رسالة نجاح */
.success-message { 
  color: green; 
  font-weight: bold; 
  text-align: center; 
  display: none; 
  margin-top: 10px; 
  font-size: 14px; 
}
.success-message::before { content: "✔ "; }

/* ======================== جدول العملاء ======================== */
.table-wrapper { 
  width: 100%; 
  overflow-x: auto; 
  margin-top: 20px; 
}
table { 
  width: 100%; 
  min-width: 400px; 
  border-collapse: collapse; 
  text-align: center; 
  font-size: 13px; 
}
th, td { 
  border: 1px solid #03a9f4; 
  padding: 8px; 
  text-align: center; 
}
th { 
  background-color: #2196f3; 
  color: white; 
}
tr:nth-child(even) td { 
  background-color: #e1bee7; 
}

/* ======================== استجابة الأجهزة الصغيرة ======================== */
@media (max-width: 600px) { 
  body { padding: 10px; } 
  h1 { font-size: 20px; } 
  .container { padding: 15px; } 
  button { font-size: 14px; } 
  table { font-size: 12px; } 
}

/* ======================== نافذة العميل الاستثنائي / تعديل ======================== */
.modal {
  display: none; 
  position: fixed;
  z-index: 999;
  left: 0; top: 0;
  width: 100%; height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.5);
}

.modal-content {
  background-color: #fff;
  margin: 5% auto;
  padding: 20px;
  border-radius: 14px;
  max-width: 480px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  position: relative;
  display: flex;
  flex-direction: column;
}

.close { 
  position: absolute; top: 10px; right: 15px; 
  font-size: 22px; font-weight: bold; 
  cursor: pointer; color:#f44336; 
}

/* ======================== توقيع المحاسب ======================== */
.signature {
  margin-top: 30px;
  font-family: 'Brush Script MT', cursive, sans-serif;
  font-size: 26px;
  color: #2c3e50;
  text-align: right; 
  font-style: italic;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
}
</style>
</head>
<body>

<h1>حاسبة الاسترداد اليومي</h1>

<!-- ======================== العملاء العاديين ======================== -->
<div class="container">
  <div class="success-message" id="successMsg">تم حفظ العميل وحساب الاسترداد بنجاح</div>

  <label>اسم العميل</label>
  <input type="text" id="clientName" placeholder="ادخل اسم العميل">
  <label>رقم العميل</label>
  <input type="text" id="clientNumber" placeholder="ادخل رقم العميل">
  <label>قيمة الباقة</label>
  <input type="number" id="packageValue" placeholder="ادخل قيمة الباقة">
  <label>عدد أيام الباقة الأساسية</label>
  <input type="number" id="packageDays" placeholder="ادخل عدد الأيام">
  <label>عدد الأيام المستفاد بها</label>
  <input type="number" id="daysUsed" placeholder="ادخل الأيام المستفاد بها">
  <label>اسم البنك</label>
  <input type="text" id="bankName" placeholder="ادخل اسم البنك">
  <label>رقم الحساب البنكي</label>
  <input type="text" id="bankAccount" placeholder="ادخل رقم الحساب">
  <label>نوع الاشتراك</label>
  <select id="subscriptionType">
    <option value="" disabled selected hidden>اختر نوع الاشتراك</option>
    <option value="تطبيق جديد">تطبيق جديد</option>
    <option value="تطبيق تجديد">تطبيق تجديد</option>
    <option value="جديد يدوي">جديد يدوي</option>
    <option value="تجديد يدوي">تجديد يدوي</option>
  </select>
  <label>الملاحظات</label>
  <input type="text" id="notes" placeholder="ادخل ملاحظات">

  <button onclick="addClientWithRefund()">💾 حفظ وحساب الاسترداد</button>
  <button onclick="openExceptionalModal()">🌟 إضافة عميل استثنائي</button>

  <!-- ======================== توقيع المحاسب ======================== -->
  <div class="signature">Accountant Mousa Muhammad</div>
</div>

<!-- ======================== نافذة تعديل العميل ======================== -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeEditModal()">&times;</span>
    <h2>تعديل بيانات العميل</h2>
    <label>اسم العميل</label>
    <input type="text" id="editName" placeholder="ادخل اسم العميل">
    <label>رقم العميل</label>
    <input type="text" id="editNumber" placeholder="ادخل رقم العميل">
    <label>قيمة الباقة</label>
    <input type="number" id="editPackageValue" placeholder="ادخل قيمة الباقة">
    <label>عدد أيام الباقة الأساسية</label>
    <input type="number" id="editPackageDays" placeholder="ادخل عدد الأيام">
    <label>عدد الأيام المستفاد بها</label>
    <input type="number" id="editDaysUsed" placeholder="ادخل الأيام المستفاد بها">
    <label>اسم البنك</label>
    <input type="text" id="editBank" placeholder="ادخل اسم البنك">
    <label>رقم الحساب البنكي</label>
    <input type="text" id="editAccount" placeholder="ادخل رقم الحساب">
    <label>نوع الاشتراك</label>
    <select id="editType">
      <option value="" disabled selected hidden>اختر نوع الاشتراك</option>
      <option value="تطبيق جديد">تطبيق جديد</option>
      <option value="تطبيق تجديد">تطبيق تجديد</option>
      <option value="جديد يدوي">جديد يدوي</option>
      <option value="تجديد يدوي">تجديد يدوي</option>
    </select>
    <label>الملاحظات</label>
    <input type="text" id="editNotes" placeholder="ادخل ملاحظات">
    <button onclick="saveEditClient()">💾 حفظ التعديلات</button>
    <button onclick="closeEditModal()">✖ إلغاء</button>
  </div>
</div>

<!-- ======================== نافذة العميل الاستثنائي ======================== -->
<div id="exceptionalModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeExceptionalModal()">&times;</span>
    <h2>إضافة عميل استثنائي</h2>
    <label>اسم العميل</label>
    <input type="text" id="exceptionalName" placeholder="ادخل اسم العميل">
    <label>رقم العميل</label>
    <input type="text" id="exceptionalNumber" placeholder="ادخل رقم العميل">
    <label>قيمة الباقة (اختياري)</label>
    <input type="number" id="exceptionalPackageValue" placeholder="ادخل قيمة الباقة">
    <label>عدد أيام الباقة (اختياري)</label>
    <input type="number" id="exceptionalPackageDays" placeholder="ادخل عدد الأيام">
    <label>عدد الأيام المستفاد بها (اختياري)</label>
    <input type="number" id="exceptionalDaysUsed" placeholder="ادخل الأيام المستفاد بها">
    <label>اسم البنك</label>
    <input type="text" id="exceptionalBank" placeholder="ادخل اسم البنك">
    <label>رقم الحساب البنكي</label>
    <input type="text" id="exceptionalAccount" placeholder="ادخل رقم الحساب">
    <label>نوع الاشتراك</label>
    <select id="exceptionalType">
      <option value="" disabled selected hidden>اختر نوع الاشتراك</option>
      <option value="تطبيق جديد">تطبيق جديد</option>
      <option value="تطبيق تجديد">تطبيق تجديد</option>
      <option value="جديد يدوي">جديد يدوي</option>
      <option value="تجديد يدوي">تجديد يدوي</option>
    </select>
    <label>المبلغ المسترد يدويًا</label>
    <input type="number" id="exceptionalRefund" placeholder="ادخل المبلغ المسترد">
    <label>الملاحظات</label>
    <input type="text" id="exceptionalNotes" placeholder="ادخل ملاحظات">
    <button onclick="saveExceptionalClient()">💾 حفظ العميل الاستثنائي</button>
  </div>
</div>

<!-- ======================== جدول العملاء ======================== -->
<div class="table-wrapper">
  <table id="clientsTable">
    <tr>
      <th>اسم العميل</th>
      <th>قيمة الباقة (عدد الأيام)</th>
      <th>الأيام المستفاد بها</th>
      <th>المبلغ المسترد</th>
      <th>تعديل</th>
      <th>حذف</th>
    </tr>
  </table>
</div>

<button onclick="exportToExcel()">📥 إصدار ملف Excel</button>

<script>
let clients = [];
let editIndex = -1;

/* ======================= إضافة العميل وحساب الاسترداد ======================= */
function addClientWithRefund() {
  const name = document.getElementById('clientName').value.trim();
  const number = document.getElementById('clientNumber').value.trim();
  const packageValue = parseFloat(document.getElementById('packageValue').value);
  const packageDays = parseFloat(document.getElementById('packageDays').value);
  const daysUsed = parseFloat(document.getElementById('daysUsed').value);
  const bank = document.getElementById('bankName').value.trim();
  const account = document.getElementById('bankAccount').value.trim();
  const type = document.getElementById('subscriptionType').value;
  const notes = document.getElementById('notes').value.trim();

  if (!name || !number) { alert("الرجاء إدخال اسم ورقم العميل"); return; }
  if (daysUsed > packageDays) { alert("عدد الأيام المستفاد بها لا يمكن أن يتجاوز عدد الأيام الكلي للباقة"); return; }

  const refund = ((packageValue / packageDays) * (packageDays - daysUsed)).toFixed(2);

  clients.push({ name, number, packageValue, packageDays, daysUsed, bank, account, type, notes, refund, exceptional:false });
  renderTable();
  clearInputs();
  document.getElementById('successMsg').style.display = 'block';
  setTimeout(()=>document.getElementById('successMsg').style.display='none',2000);
}

/* ======================= مسح الحقول ======================= */
function clearInputs() {
  document.querySelectorAll('.container input').forEach(i=>i.value='');
  document.querySelectorAll('.container select').forEach(s=>s.selectedIndex=0);
}

/* ======================= فتح/اغلاق تعديل العميل ======================= */
function openEditModal(index){
  editIndex = index;
  const c = clients[index];
  document.getElementById('editName').value = c.name;
  document.getElementById('editNumber').value = c.number;
  document.getElementById('editPackageValue').value = c.packageValue;
  document.getElementById('editPackageDays').value = c.packageDays;
  document.getElementById('editDaysUsed').value = c.daysUsed;
  document.getElementById('editBank').value = c.bank;
  document.getElementById('editAccount').value = c.account;
  document.getElementById('editType').value = c.type;
  document.getElementById('editNotes').value = c.notes;
  document.getElementById('editModal').style.display='block';
}
function closeEditModal(){ document.getElementById('editModal').style.display='none'; }

/* ======================= حفظ تعديل العميل ======================= */
function saveEditClient(){
  const c = clients[editIndex];
  c.name = document.getElementById('editName').value.trim();
  c.number = document.getElementById('editNumber').value.trim();
  c.packageValue = parseFloat(document.getElementById('editPackageValue').value);
  c.packageDays = parseFloat(document.getElementById('editPackageDays').value);
  c.daysUsed = parseFloat(document.getElementById('editDaysUsed').value);
  c.bank = document.getElementById('editBank').value.trim();
  c.account = document.getElementById('editAccount').value.trim();
  c.type = document.getElementById('editType').value;
  c.notes = document.getElementById('editNotes').value.trim();

  c.refund = ((c.packageValue / c.packageDays)*(c.packageDays-c.daysUsed)).toFixed(2);

  renderTable();
  closeEditModal();
}

/* ======================= فتح/اغلاق العميل الاستثنائي ======================= */
function openExceptionalModal(){ document.getElementById('exceptionalModal').style.display='block'; }
function closeExceptionalModal(){ document.getElementById('exceptionalModal').style.display='none'; }

/* ======================= حفظ العميل الاستثنائي ======================= */
function saveExceptionalClient(){
  const name = document.getElementById('exceptionalName').value.trim();
  const number = document.getElementById('exceptionalNumber').value.trim();
  const packageValue = parseFloat(document.getElementById('exceptionalPackageValue').value)||0;
  const packageDays = parseFloat(document.getElementById('exceptionalPackageDays').value)||0;
  const daysUsed = parseFloat(document.getElementById('exceptionalDaysUsed').value)||0;
  const bank = document.getElementById('exceptionalBank').value.trim();
  const account = document.getElementById('exceptionalAccount').value.trim();
  const type = document.getElementById('exceptionalType').value;
  const refund = parseFloat(document.getElementById('exceptionalRefund').value);
  const notes = document.getElementById('exceptionalNotes').value.trim();

  if(!name||!number||isNaN(refund)){ alert("الرجاء إدخال الاسم والرقم والمبلغ المسترد"); return; }

  clients.push({name,number,packageValue,packageDays,daysUsed,bank,account,type,notes,refund:refund.toFixed(2),exceptional:true});
  renderTable();
  closeExceptionalModal();

  ['exceptionalName','exceptionalNumber','exceptionalPackageValue','exceptionalPackageDays','exceptionalDaysUsed','exceptionalBank','exceptionalAccount','exceptionalType','exceptionalRefund','exceptionalNotes'].forEach(id=>document.getElementById(id).value='');
}

/* ======================= عرض الجدول ======================= */
function renderTable(){
  const table = document.getElementById('clientsTable');
  table.innerHTML=`<tr>
    <th>اسم العميل</th>
    <th>قيمة الباقة (عدد الأيام)</th>
    <th>الأيام المستفاد بها</th>
    <th>المبلغ المسترد</th>
    <th>تعديل</th>
    <th>حذف</th>
  </tr>`;

  clients.forEach((c,index)=>{
    table.innerHTML += `<tr ${c.exceptional?'style="background-color:#fff3e0;"':''}>
      <td>${c.name}</td>
      <td>${c.packageValue} (${c.packageDays})</td>
      <td>${c.daysUsed}</td>
      <td>${c.refund||'-'}</td>
      <td><button class="edit" onclick="openEditModal(${index})">✏️ تعديل</button></td>
      <td><button class="delete" onclick="deleteClient(${index})">🗑️ حذف</button></td>
    </tr>`;
  });
}

/* ======================= حذف العميل ======================= */
function deleteClient(index){ 
  if(confirm("هل أنت متأكد من حذف هذا العميل؟")){
    clients.splice(index,1);
    renderTable();
  }
}

/* ======================= تصدير Excel ======================= */
function exportToExcel(){
  let html = `<table border='1' style='border-collapse:collapse; font-family:Tahoma; direction:rtl;'>`;
  html += `<tr>
    <th style="background-color:#2196f3; color:white;">اسم العميل</th>
    <th style="background-color:#2196f3; color:white;">رقم العميل</th>
    <th style="background-color:#2196f3; color:white;">قيمة الباقة (عدد الأيام)</th>
    <th style="background-color:#2196f3; color:white;">عدد الأيام المستفاد بها</th>
    <th style="background-color:#2196f3; color:white;">اسم البنك</th>
    <th style="background-color:#2196f3; color:white;">رقم الحساب</th>
    <th style="background-color:#2196f3; color:white;">نوع الاشتراك</th>
    <th style="background-color:#2196f3; color:white;">المبلغ المسترد</th>
    <th style="background-color:#2196f3; color:white;">الملاحظات</th>
  </tr>`;

  clients.forEach(c=>{
    html += `<tr>
      <td>${c.name}</td>
      <td>${c.number}</td>
      <td>${c.packageValue} (${c.packageDays})</td>
      <td>${c.daysUsed}</td>
      <td>${c.bank}</td>
      <td>${c.account}</td>
      <td>${c.type}</td>
      <td>${c.refund}</td>
      <td>${c.notes}</td>
    </tr>`;
  });

  html += "</table>";
  const blob = new Blob([html], {type:"application/vnd.ms-excel"});
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  const today = new Date();
  const dateStr = today.toLocaleDateString('ar-EG', {day:'2-digit',month:'long',year:'numeric'});
  link.href=url;
  link.download=`الاسترداد اليومي ${dateStr}.xls`;
  link.click();
}
</script>

</body>
</html>
