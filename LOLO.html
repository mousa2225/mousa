<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>حاسبة الاسترداد المالي - متعددة العملاء</title>
<style>
body { font-family: 'Cairo', sans-serif; background-color: #f0f6fa; color: #333; padding: 20px; }
h2 { text-align: center; color: #1565c0; margin-bottom: 20px; }
.calculator { background: #fff; padding: 20px; border-radius: 14px; max-width: 1100px; margin: auto; box-shadow: 0 6px 18px rgba(0,0,0,0.1); }
.client-section { background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 15px; position: relative; }
.client-section h3 { color: #0d47a1; margin-bottom: 10px; }
label { display: block; margin-top: 10px; font-weight: bold; color: #0d47a1; }
input { width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #bbdefb; border-radius: 8px; font-size: 15px; }
.remove-btn { position: absolute; top: 10px; left: 10px; background: #e53935; color: white; border: none; border-radius: 50%; width: 26px; height: 26px; font-weight: bold; cursor: pointer; }
button { background: #1e88e5; border: none; color: white; padding: 10px 18px; border-radius: 8px; font-size: 15px; cursor: pointer; margin: 5px 5px 10px 0; }
button:hover { background: #1565c0; }
.add-btn { background: #43a047; }
.add-btn:hover { background: #2e7d32; }
</style>
</head>
<body>

<div class="calculator">
<h2>📊 حاسبة الاسترداد المالي لعدة عملاء</h2>

<div id="clientsContainer"></div>

<button class="add-btn" onclick="addClient()">➕ إضافة عميل</button>
<button onclick="calculateAll()">💰 احسب لجميع العملاء</button>
<button onclick="copyRows()">📋 نسخ النتائج (ثلاث خانات فقط)</button>
<button onclick="exportExcel()">📥 تصدير إلى Excel</button>

<div class="result-section" id="results"></div>
</div>

<script>
let clientCount = 0;
let clientsData = [];

function addClient() {
  clientCount++;
  const id = clientCount;
  clientsData.push(id);
  const clientHTML = `
  <div class="client-section" id="client-${id}">
    <button class="remove-btn" onclick="removeClient(${id})">×</button>
    <h3>👤 بيانات العميل</h3>
    <label>اسم العميل:</label><input type="text" id="name-${id}">
    <label>رقم العميل:</label><input type="text" id="id-${id}">
    <label>قيمة الباقة المشترك عليها (ريال):</label><input type="number" id="price-${id}">
    <label>عدد أيام الباقة:</label><input type="number" id="days-${id}">
    <label>عدد الأيام المستفاد بها:</label><input type="number" id="used-${id}">
    <label>اسم البنك:</label><input type="text" id="bank-${id}">
    <label>رقم الحساب البنكي:</label><input type="text" id="account-${id}">
    <label>نوع الاشتراك:</label><input type="text" id="subscription-${id}">
    <label>الملاحظات:</label><input type="text" id="notes-${id}">
  </div>`;
  document.getElementById("clientsContainer").insertAdjacentHTML("beforeend", clientHTML);
}

function removeClient(id) {
  const el = document.getElementById(`client-${id}`);
  if (el) el.remove();
  clientsData = clientsData.filter(cid => cid !== id);
}

function calculateAll() {
  if (clientsData.length === 0) { alert("الرجاء إضافة عميل واحد على الأقل."); return; }

  let tableHTML = `<table id="resultTable" style="border-collapse:collapse; width:100%; table-layout:fixed;"><thead>
  <tr style="background-color:#4CAF50; color:white; font-weight:bold; font-size:18px;">
  <th style="width:120px;">اسم العميل</th>
  <th style="width:100px;">رقم العميل</th>
  <th style="width:130px;">قيمة الباقة المشترك عليها</th>
  <th style="width:120px;">عدد الأيام المستفاد بها</th>
  <th style="width:120px;">اسم البنك</th>
  <th style="width:130px;">رقم الحساب البنكي</th>
  <th style="width:120px;">نوع الاشتراك</th>
  <th style="width:120px;">المبلغ المسترد</th>
  <th style="width:150px;">الملاحظات</th>
  </tr></thead><tbody>`;

  clientsData.forEach((id,index)=>{
    const c = document.getElementById(`client-${id}`);
    const name=c.querySelector(`#name-${id}`).value||"";
    const cid=c.querySelector(`#id-${id}`).value||"";
    const price=parseFloat(c.querySelector(`#price-${id}`).value)||0;
    const days=parseFloat(c.querySelector(`#days-${id}`).value)||1;
    const used=parseFloat(c.querySelector(`#used-${id}`).value)||0;
    const bank=c.querySelector(`#bank-${id}`).value||"";
    const account=c.querySelector(`#account-${id}`).value||"";
    const subscription=c.querySelector(`#subscription-${id}`).value||"";
    const notes=c.querySelector(`#notes-${id}`).value||"";

    const remaining = Math.max(days-used,0);
    const refund = (price/days)*remaining;
    const bg = index%2===0?'#f9fcff':'#e8f0fe';
    tableHTML+=`<tr style="background-color:${bg}; font-weight:bold; font-size:16px;">
    <td>${name}</td><td>${cid}</td><td>${price.toFixed(2)}(${days})</td><td>${used}</td>
    <td>${bank}</td><td>${account}</td><td>${subscription}</td>
    <td>${refund.toFixed(2)}</td><td>${notes}</td></tr>`;
  });

  tableHTML+=`<tr><td colspan="9" style="text-align:right; font-weight:bold; font-style:italic; color:#FF5722; padding:15px; font-size:16px;">Accountant Mousa</td></tr>`;
  tableHTML+=`</tbody></table>`;
  document.getElementById("results").innerHTML = tableHTML;
}

function copyRows(){
  const table=document.getElementById("resultTable");
  if(!table) return alert("لا توجد نتائج للنسخ!");
  let txt="";
  for(let i=1;i<table.rows.length-1;i++){
    const cells=table.rows[i].cells;
    txt+=cells[2].innerText+"\t"+cells[3].innerText+"\t"+cells[7].innerText+"\n";
  }
  navigator.clipboard.writeText(txt).then(()=>alert("تم النسخ!")).catch(()=>alert("حدث خطأ."));
}

function exportExcel(){
  if(clientsData.length===0){ alert("لا توجد بيانات للتصدير!"); return;}
  const today=new Date();
  const yesterday=new Date(today); yesterday.setDate(today.getDate()-1);
  const day=yesterday.getDate();
  const monthNames=["يناير","فبراير","مارس","ابريل","مايو","يونيو","يوليو","اغسطس","سبتمبر","اكتوبر","نوفمبر","ديسمبر"];
  const month=monthNames[yesterday.getMonth()];
  const fileName=`ملف الاسترداد اليومي ${day} ${month}.xls`;

  let excelHtml=`<table border="1" style="border-collapse:collapse; font-family:Arial; font-size:16px; table-layout:fixed;">
  <tr style="background-color:#4CAF50; color:white; font-weight:bold; font-size:18px;">
  <th style="width:120px;">اسم العميل</th>
  <th style="width:100px;">رقم العميل</th>
  <th style="width:130px;">قيمة الباقة المشترك عليها</th>
  <th style="width:120px;">عدد الأيام المستفاد بها</th>
  <th style="width:120px;">اسم البنك</th>
  <th style="width:130px;">رقم الحساب البنكي</th>
  <th style="width:120px;">نوع الاشتراك</th>
  <th style="width:120px;">المبلغ المسترد</th>
  <th style="width:150px;">الملاحظات</th>
  </tr>`;

  clientsData.forEach((id,index)=>{
    const c = document.getElementById(`client-${id}`);
    const name=c.querySelector(`#name-${id}`).value||"";
    const cid=c.querySelector(`#id-${id}`).value||"";
    const price=parseFloat(c.querySelector(`#price-${id}`).value)||0;
    const days=parseFloat(c.querySelector(`#days-${id}`).value)||1;
    const used=parseFloat(c.querySelector(`#used-${id}`).value)||0;
    const bank=c.querySelector(`#bank-${id}`).value||"";
    const account=c.querySelector(`#account-${id}`).value||"";
    const subscription=c.querySelector(`#subscription-${id}`).value||"";
    const notes=c.querySelector(`#notes-${id}`).value||"";

    const remaining = Math.max(days-used,0);
    const refund = (price/days)*remaining;
    const priceWithDays = `${price.toFixed(2)}(${days})`;
    const bg = index%2===0?'#f9fcff':'#e8f0fe';

    excelHtml+=`<tr style="background-color:${bg}; font-weight:bold; font-size:16px;">
    <td>${name}</td><td>${cid}</td><td>${priceWithDays}</td><td>${used}</td>
    <td>${bank}</td><td>${account}</td><td>${subscription}</td>
    <td>${refund.toFixed(2)}</td><td>${notes}</td></tr>`;
  });

  excelHtml+=`<tr><td colspan="9" style="text-align:right; font-weight:bold; font-style:italic; color:#FF5722; padding:15px; font-size:16px;">Accountant Mousa</td></tr>`;
  excelHtml+=`</table>`;

  const blob = new Blob([excelHtml], { type: "application/vnd.ms-excel" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = fileName;
  a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
