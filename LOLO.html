<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>حاسبة الاسترداد المالي - متعددة العملاء</title>
<style>
  body { font-family: 'Cairo', sans-serif; background-color: #f0f6fa; color: #333; padding: 20px; }
  h2 { text-align: center; color: #1565c0; margin-bottom: 20px; }
  .calculator { background: #fff; padding: 20px; border-radius: 14px; max-width: 1100px; margin: auto; box-shadow: 0 6px 18px rgba(0,0,0,0.1); }
  .client-section { background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 15px; position: relative; }
  .client-section h3 { color: #0d47a1; margin-bottom: 10px; }
  label { display: block; margin-top: 10px; font-weight: bold; color: #0d47a1; }
  input { width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #bbdefb; border-radius: 8px; font-size: 15px; }
  .remove-btn { position: absolute; top: 10px; left: 10px; background: #e53935; color: white; border: none; border-radius: 50%; width: 26px; height: 26px; font-weight: bold; cursor: pointer; }
  button { background: #1e88e5; border: none; color: white; padding: 10px 18px; border-radius: 8px; font-size: 15px; cursor: pointer; margin: 5px 5px 10px 0; }
  button:hover { background: #1565c0; }
  .add-btn { background: #43a047; }
  .add-btn:hover { background: #2e7d32; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 16px; }
  th, td { border: 1px solid #bbdefb; padding: 12px; text-align: center; }
  th { background-color: #4CAF50; color: white; font-weight:bold; font-size:18px; }
  td { background: #f9fcff; }
</style>
</head>
<body>

<div class="calculator">
  <h2>📊 حاسبة الاسترداد المالي لعدة عملاء</h2>

  <div id="clientsContainer"></div>

  <button class="add-btn" onclick="addClient()">➕ إضافة عميل</button>
  <button onclick="calculateAll()">💰 احسب لجميع العملاء</button>
  <button onclick="copyRows()">📋 نسخ النتائج (ثلاث خانات فقط)</button>
  <button onclick="exportExcel()">📥 تصدير إلى Excel</button>

  <div class="result-section" id="results"></div>
</div>

<script>
let clientCount = 0;

// تخزين العملاء فعلياً لضمان معرف فريد حتى بعد حذف أي عميل
let clientsData = [];

function addClient() {
  clientCount++;
  const id = clientCount;
  clientsData.push(id);

  const clientHTML = `
  <div class="client-section" id="client-${id}">
    <button class="remove-btn" onclick="removeClient(${id})">×</button>
    <h3>👤 بيانات العميل</h3>
    <label>اسم العميل:</label>
    <input type="text" id="name-${id}" placeholder="مثال: أحمد محمد">
    <label>رقم العميل:</label>
    <input type="text" id="id-${id}" placeholder="مثال: 123456">
    <label>قيمة الباقة المشترك عليها (ريال):</label>
    <input type="number" id="price-${id}" placeholder="مثال: 1295">
    <label>عدد أيام الباقة:</label>
    <input type="number" id="days-${id}" placeholder="مثال: 24">
    <label>عدد الأيام المستفاد بها:</label>
    <input type="number" id="used-${id}" placeholder="مثال: 19">
    <label>اسم البنك:</label>
    <input type="text" id="bank-${id}" placeholder="مثال: Alinma">
    <label>رقم الحساب البنكي:</label>
    <input type="text" id="account-${id}" placeholder="مثال: 1234567890">
    <label>نوع الاشتراك:</label>
    <input type="text" id="subscription-${id}" placeholder="مثال: شهرية">
    <label>الملاحظات:</label>
    <input type="text" id="notes-${id}" placeholder="مثال: بدون ملاحظات">
  </div>`;
  document.getElementById("clientsContainer").insertAdjacentHTML("beforeend", clientHTML);
}

function removeClient(id) {
  const el = document.getElementById(`client-${id}`);
  if (el) el.remove();
  clientsData = clientsData.filter(cid => cid !== id);
}

function calculateAll() {
  if (clientsData.length === 0) { alert("الرجاء إضافة عميل واحد على الأقل."); return; }

  let tableHTML = `
  <table id="resultTable">
    <thead>
      <tr>
        <th>اسم العميل</th>
        <th>رقم العميل</th>
        <th>قيمة الباقة المشترك عليها</th>
        <th>عدد الأيام المستفاد بها</th>
        <th>اسم البنك</th>
        <th>رقم الحساب البنكي</th>
        <th>نوع الاشتراك</th>
        <th>المبلغ المسترد</th>
        <th>الملاحظات</th>
      </tr>
    </thead>
    <tbody>`;

  clientsData.forEach((id, index) => {
    const client = document.getElementById(`client-${id}`);
    const name = client.querySelector(`#name-${id}`).value || "";
    const cid = client.querySelector(`#id-${id}`).value || "";
    const price = parseFloat(client.querySelector(`#price-${id}`).value) || 0;
    const days = parseFloat(client.querySelector(`#days-${id}`).value) || 1;
    const used = parseFloat(client.querySelector(`#used-${id}`).value) || 0;
    const bank = client.querySelector(`#bank-${id}`).value || "";
    const account = client.querySelector(`#account-${id}`).value || "";
    const subscription = client.querySelector(`#subscription-${id}`).value || "";
    const notes = client.querySelector(`#notes-${id}`).value || "";

    const remaining = Math.max(days - used, 0);
    const refund = (price / days) * remaining;

    const bgColor = index % 2 === 0 ? '#f9fcff' : '#e8f0fe';

    tableHTML += `
    <tr style="background-color:${bgColor}; font-weight:bold; font-size:16px;">
      <td>${name}</td>
      <td>${cid}</td>
      <td>${price.toFixed(2)}</td>
      <td>${used}</td>
      <td>${bank}</td>
      <td>${account}</td>
      <td>${subscription}</td>
      <td style="color:${refund>0?'#2e7d32':'#d32f2f'}; font-weight:bold;">${refund.toFixed(2)}</td>
      <td>${notes}</td>
    </tr>`;
  });

  tableHTML += `
    <tr>
      <td colspan="9" style="text-align:right; font-weight:bold; font-style:italic; color:#FF5722; padding:15px; font-size:16px;">
        Accountant Mousa
      </td>
    </tr>`;

  tableHTML += `</tbody></table>`;
  document.getElementById("results").innerHTML = tableHTML;
}

// النسخ وتصدير Excel تبقى كما في النسخ السابقة
</script>
</body>
</html>
